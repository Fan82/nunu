import React, { useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { X } from "lucide-react";
import van1 from "../assets/images/van1.webp"; // 正面小車
import van2 from "../assets/images/van2.webp"; // 換方向小車

const points = [
  {
    id: 1,
    x: 340,
    y: 120,
    modal: {
      title: "nunu Shop",
      address: "266 South Bridge Rd, #000, Singapore",
      time: "Mon - Sun | 10:00 - 18:00",
      img: "../assets/images/shop.png",
    },
  },
  {
    id: 2,
    x: 300,
    y: 250,
    modal: {
      title: "nunu Van",
      address: "3 Temasek Blvd, Singapore 038983",
      time: "Weekend | 11:00 - 18:00",
      img: "../assets/images/van.png",
    },
  },
];

export default function MapScene() {
  const pathRef = useRef(null);
  const [progress, setProgress] = useState(0); // 0=start, 1=end
  const [currentPoint, setCurrentPoint] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [carImage, setCarImage] = useState(van1);

  // Define the progress value for each point (0=start, 1=end)
  const pointProgress = [0, 1]; // You can add more for more points

  const animateTo = (targetProgress) => {
    setShowModal(false);
    let start = progress;
    let startTime = null;
    const duration = 1000; // 1 second

    function animate(time) {
      if (!startTime) startTime = time;
      const elapsed = time - startTime;
      const t = Math.min(elapsed / duration, 1);
      const newProgress = start + (targetProgress - start) * t;
      setProgress(newProgress);
      if (t < 1) {
        requestAnimationFrame(animate);
      } else {
        setTimeout(() => setShowModal(true), 1000); // Show modal after 1s
      }
    }
    requestAnimationFrame(animate);
  };

  const handleClick = (point, idx) => {
    setCarImage(point.id === 2 ? van2 : van1);
    setCurrentPoint(point);
    animateTo(pointProgress[idx]);
  };

  let vanPos = { x: 80, y: 50 };
  if (pathRef.current) {
    const length = pathRef.current.getTotalLength();
    const point = pathRef.current.getPointAtLength(progress * length);
    vanPos = { x: point.x, y: point.y };
  }

  return (
    <div className="relative w-full h-96 overflow-hidden">
      <svg
        className="absolute w-full h-full"
        width="970"
        height="435"
        viewBox="0 0 970 435"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          ref={pathRef}
          d="M323.957 434.466H309.89V427.416H323.957V434.466ZM352.092 434.466H338.024V427.416H352.092V434.466ZM380.159 434.466H366.092V427.416H380.159V434.466ZM408.227 434.466H394.159V427.416H408.227V434.466ZM436.294 434.466H422.227V427.416H436.294V434.466ZM464.361 434.466H450.294V427.416H464.361V434.466ZM492.429 434.466H478.361V427.416H492.429V434.466ZM520.496 434.466H506.429V427.416H520.496V434.466ZM548.563 434.466H534.496V427.416H548.563V434.466ZM576.631 434.466H562.563V427.416H576.631V434.466ZM604.698 434.466H590.631V427.416H604.698V434.466ZM632.766 434.466H618.698V427.416H632.766V434.466ZM660.833 434.466H646.766V427.416H660.833V434.466ZM688.901 434.466H674.833V427.416H688.901V434.466ZM716.969 434.466H702.901V427.416H716.969V434.466ZM745.036 434.466H730.969V427.416H745.036V434.466ZM773.104 434.466H759.036V427.416H773.104V434.466ZM801.171 434.466H787.104V427.416H801.171V434.466ZM829.238 434.466H815.171V427.416H829.238V434.466ZM857.307 434.466H843.238V427.416H857.307V434.466ZM885.374 434.466H871.307V427.416H885.374V434.466ZM913.441 434.466H899.374V427.416H913.441V434.466ZM941.509 434.466H927.441V427.416H941.509V434.466ZM969.576 434.466H955.509V427.416H969.576V434.466ZM283.733 421.088C287.959 422.522 292.308 423.69 296.76 424.57L296.074 428.028H296.075L295.392 431.484C290.633 430.543 285.985 429.296 281.469 427.764L283.733 421.088ZM259.606 409.17C263.334 411.665 267.233 413.924 271.281 415.924L268.158 422.243C263.832 420.106 259.667 417.692 255.685 415.026L259.606 409.17ZM239.366 391.408C242.336 394.792 245.524 397.98 248.908 400.95L244.258 406.247C240.644 403.075 237.24 399.671 234.068 396.058L239.366 391.408ZM224.391 369.035C226.391 373.083 228.649 376.982 231.145 380.709L225.287 384.631C222.621 380.649 220.208 376.483 218.07 372.157L224.391 369.035ZM215.744 343.557C216.625 348.009 217.793 352.358 219.227 356.583L212.55 358.848C211.017 354.331 209.771 349.682 208.83 344.924L215.744 343.557ZM213.999 316.668C213.855 318.901 213.781 321.154 213.781 323.425C213.781 325.696 213.855 327.949 213.999 330.182L206.965 330.636C206.811 328.252 206.731 325.848 206.731 323.425C206.731 321.002 206.811 318.597 206.965 316.213L213.999 316.668ZM219.227 290.268C217.793 294.493 216.625 298.841 215.744 303.293L208.83 301.925C209.771 297.167 211.017 292.518 212.55 288.002L219.227 290.268ZM231.145 266.142C228.649 269.869 226.391 273.768 224.391 277.815L218.07 274.692C220.208 270.366 222.621 266.201 225.287 262.219L231.145 266.142ZM248.908 245.901C245.524 248.871 242.336 252.06 239.366 255.443L234.068 250.793C237.24 247.179 240.644 243.775 244.258 240.604L248.908 245.901ZM271.281 230.928C267.233 232.928 263.334 235.186 259.606 237.682L255.685 231.824C259.667 229.158 263.832 226.745 268.158 224.607L271.281 230.928ZM296.76 221.944C292.308 222.825 287.959 223.993 283.733 225.427L281.469 218.75C285.985 217.217 290.633 215.971 295.392 215.029L296.76 221.944ZM323.957 220.317H309.89V213.268H323.957V220.317ZM352.092 220.317H338.024V213.268H352.092V220.317ZM380.227 220.317H366.159V213.268H380.227V220.317ZM408.362 220.317H394.295V213.268H408.362V220.317ZM436.498 220.317H422.43V213.268H436.498V220.317ZM464.634 220.317H450.566V213.268H464.634V220.317ZM492.769 220.317H478.701V213.268H492.769V220.317ZM520.904 220.317H506.837V213.268H520.904V220.317ZM549.039 220.317H534.972V213.268H549.039V220.317ZM577.174 220.317H563.106V213.268H577.174V220.317ZM605.31 220.317H591.242V213.268H605.31V220.317ZM633.445 220.317H619.378V213.268H633.445V220.317ZM661.581 220.317H647.514V213.268H661.581V220.317ZM689.716 220.317H675.648V213.268H689.716V220.317ZM718.028 220.083C715.645 220.237 713.24 220.316 710.817 220.316H703.784V213.267H710.817C713.088 213.267 715.342 213.193 717.574 213.049L718.028 220.083ZM746.239 214.496C741.723 216.029 737.074 217.275 732.315 218.217L730.948 211.303C735.4 210.422 739.749 209.254 743.975 207.82L746.239 214.496ZM772.022 201.761C768.04 204.427 763.875 206.84 759.549 208.978L756.427 202.658C760.475 200.658 764.373 198.4 768.101 195.904L772.022 201.761ZM793.639 182.79C790.467 186.404 787.063 189.808 783.449 192.979L778.8 187.683C782.184 184.713 785.372 181.524 788.342 178.141L793.639 182.79ZM809.637 158.89C807.499 163.216 805.086 167.381 802.42 171.363L796.563 167.441C799.059 163.714 801.317 159.815 803.317 155.768L809.637 158.89ZM818.877 131.658C817.936 136.416 816.69 141.066 815.157 145.582L808.481 143.317C809.915 139.092 811.082 134.743 811.963 130.291L818.877 131.658ZM820.742 102.947C820.896 105.331 820.976 107.736 820.976 110.159C820.976 112.582 820.896 114.986 820.742 117.37L813.708 116.916C813.852 114.683 813.926 112.43 813.926 110.159C813.926 107.888 813.852 105.635 813.708 103.402L820.742 102.947ZM815.157 74.7363C816.69 79.2527 817.936 83.901 818.877 88.6592L815.422 89.3438L815.421 89.3428L811.963 90.0273C811.082 85.5755 809.915 81.2268 808.481 77.002L815.157 74.7363ZM802.42 48.9512C805.086 52.9333 807.499 57.0986 809.637 61.4248L803.317 64.5479C801.317 60.5001 799.059 56.6014 796.563 52.874L802.42 48.9512ZM783.449 27.3359C787.063 30.5075 790.467 33.9118 793.639 37.5254L790.991 39.8506L790.99 39.8496L788.342 42.1758C785.372 38.7919 782.184 35.6037 778.8 32.6338L783.449 27.3359ZM759.549 11.3398C763.875 13.4773 768.04 15.8907 772.022 18.5566L768.101 24.4141C764.373 21.9187 760.475 19.6601 756.427 17.6602L759.549 11.3398ZM732.315 2.09766C737.074 3.03896 741.723 4.28561 746.239 5.81836L743.975 12.4951C739.749 11.0612 735.4 9.89348 730.948 9.0127L732.315 2.09766ZM710.817 0C713.24 0 715.645 0.079368 718.028 0.233398L717.574 7.26758C715.342 7.1233 713.088 7.0498 710.817 7.0498H703.784V0H710.817ZM14.4678 7.0498H0.399414V0H14.4678V7.0498ZM42.6025 7.0498H28.5352V0H42.6025V7.0498ZM70.7393 7.0498H56.6719V0H70.7393V7.0498ZM98.874 7.0498H84.8066V0H98.874V7.0498ZM127.01 7.0498H112.942V0H127.01V7.0498ZM155.145 7.0498H141.077V0H155.145V7.0498ZM183.279 7.0498H169.212V0H183.279V7.0498ZM211.415 7.0498H197.348V0H211.415V7.0498ZM239.551 7.0498H225.482V0H239.551V7.0498ZM267.687 7.0498H253.619V0H267.687V7.0498ZM295.821 7.0498H281.754V0H295.821V7.0498ZM323.957 7.0498H309.89V0H323.957V7.0498ZM352.092 7.0498H338.024V0H352.092V7.0498ZM380.227 7.0498H366.159V0H380.227V7.0498ZM408.362 7.0498H394.295V0H408.362V7.0498ZM436.497 7.0498H422.43V0H436.497V7.0498ZM464.633 7.0498H450.565V0H464.633V7.0498ZM492.769 7.0498H478.701V0H492.769V7.0498ZM520.904 7.0498H506.837V0H520.904V7.0498ZM549.039 7.0498H534.972V0H549.039V7.0498ZM577.174 7.0498H563.106V0H577.174V7.0498ZM605.31 7.0498H591.242V0H605.31V7.0498ZM633.444 7.0498H619.377V0H633.444V7.0498ZM661.58 7.0498H647.513V0H661.58V7.0498ZM689.716 7.0498H675.647V0H689.716V7.0498Z"
          fill="#3B3B3B"
        />
      </svg>

      {/* 車子 */}
      <motion.img
        src={carImage}
        alt="van"
        className="absolute w-36 h-36 aspect-auto"
        style={{
          left: vanPos.x,
          top: vanPos.y,
          transform: "translate(-50%, -50%)",
          transition: "left 1s linear, top 1s linear",
        }}
      />

      {/* 地點按鈕 */}
      {points.map((p, idx) => (
        <button
          key={p.id}
          onClick={() => handleClick(p, idx)}
          className="absolute w-8 h-8 rounded-full bg-white border text-sm font-bold flex items-center justify-center shadow"
          style={{ left: p.x, top: p.y }}
        >
          {p.id}
        </button>
      ))}

      {/* Modal */}
      <AnimatePresence>
        {showModal && currentPoint && (
          <motion.div
            key="modal"
            initial={{ scaleX: 0 }}
            animate={{ scaleX: 1 }}
            exit={{ scaleX: 0 }}
            transition={{ duration: 0.4 }}
            className="absolute md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 origin-center bg-white border-2 border-red-400 p-4 rounded-xl shadow-xl flex gap-4 items-center"
          >
            <img
              src={currentPoint.modal.img}
              alt="img"
              className="w-24 h-24 object-contain"
            />
            <div className="text-left">
              <h2 className="text-base font-semibold">
                {currentPoint.modal.title}
              </h2>
              <p className="text-sm text-gray-700">
                {currentPoint.modal.address}
              </p>
              <p className="text-xs text-gray-500">{currentPoint.modal.time}</p>
            </div>
            <button
              onClick={() => setShowModal(false)}
              className="absolute top-2 right-2 text-red-500 hover:text-red-700"
            >
              <X />
            </button>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
